---
title: "top_100_heatmap_and_indicative_species_analyze"
author: "Jingzhe Jiang"
date: "2015年10月19日"
output: 
  html_document:
    toc: true
    toc_depth: 4
    keep_md: true
---
# top 100 otus
combine top 100 otus of each oyster samples in cohort 2

## read data
```{r}
library(dplyr)
origin_data <- read.csv("D:/bioinfo/UBC_data/otu_summaries/otu_table_os_top960_NormAndRanked.csv", header = TRUE, row.names = 1) # single number giving the column of the table which contains the row names. But dpyr never preserve row names, you should use add_rownames() to preserve them!
str(origin_data)
row.names(origin_data) %>% head
colnames(origin_data)
mydata <- origin_data %>% add_rownames %>% tbl_df
mydata %>% glimpse
row.names(mydata) %>% head
```
## select top 100 otus ids
from each samples (os7-os12), than combined and get rid of redundences, than filtrate from my data
```{r}
top_7 <- mydata %>% 
    arrange(desc(os7)) %>% 
      select(rowname) %>% 
        head(100)
top_8 <- mydata %>% 
    arrange(desc(os8)) %>% 
      select(rowname) %>% 
        head(100)
top_9 <- mydata %>% 
    arrange(desc(os9)) %>% 
      select(rowname) %>% 
        head(100)
top_10 <- mydata %>% 
    arrange(desc(os10)) %>% 
      select(rowname) %>% 
        head(100)
top_11 <- mydata %>% 
    arrange(desc(os11)) %>% 
      select(rowname) %>% 
        head(100)
top_12 <- mydata %>% 
    arrange(desc(os12)) %>% 
      select(rowname) %>% 
        head(100)
# all = TRUE means full Outer join tables
top_cohort2 <- merge(top_12,top_11, by = "rowname", all = TRUE)
top_cohort2 <- merge(top_cohort2,top_10, by = "rowname", all = TRUE)
top_cohort2 <- merge(top_cohort2,top_9, by = "rowname", all = TRUE)
top_cohort2 <- merge(top_cohort2,top_8, by = "rowname", all = TRUE)
top_cohort2 <- merge(top_cohort2,top_7, by = "rowname", all = TRUE)
top_cohort2_data <- merge(mydata, top_cohort2, by = "rowname", all.y = TRUE)
top_cohort2_data %>% arrange(desc(os8)) %>% head
```
## normalized columns
based on the total reads of each sample
```{r}
# clip total reads from excel, than paste into R
refs <- read.delim("refs.txt", header = TRUE)
refs %>% glimpse
## top_normal <- top_cohort2_data[,2:13]*311167/as.numeric(refs[1,2:13])
## 两个dataframe相除必须维度一致，或者将分母转变为vector才可以相除。但above is not correct, but I don't know why!
top_normal <- top_cohort2_data[,2:13]*311167/refs[rep(1,251),2:13]
#两个dataframe相除必须维度一致，因此用rep(1,251)复制了refs中的ttlReads数据，使其变成dataframe。参见如下：
refs[rep(1,5),1:13]
rownames(top_normal) <- top_cohort2_data$rowname
top_normal %>% str
top_cohort2_data %>% str
identical(row.names(top_normal),top_cohort2_data$rowname)
identical(top_normal$os2,top_cohort2_data$os2) # one is num, one is int
identical(as.integer(top_normal$os2),top_cohort2_data$os2)
```
## heatmap with ggplot2
```{r}
library(ggplot2)
library(reshape2)
# the dataframe is converted from wide format to a long format
top_melt <- top_normal %>% 
  add_rownames %>% 
    select(rowname,os7,os8,os9,os10,os11,os12) %>% 
      melt
(p <- ggplot(top_melt, aes(variable, rowname)) + geom_tile(aes(fill = log10(value)), colour = "white") + scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 2) + theme(axis.text.y = element_text(size = 1), axis.text.x = element_text(size = 4)) + coord_fixed(ratio=0.15))
```
## cluster otus on heatmap
```{r}
euc_dist <- top_normal %>% dist(method = "euclidean") 
otuclust <- hclust(euc_dist, method = "average")
den_order <- otuclust %>% as.dendrogram 

# den_order %>% order.dendrogram
den_order %>% str
# euc_dist %>% head
# typeof(euc_dist)
# mode(euc_dist)s
# class(euc_dist)
otuclust %>% str
# otuclust %>% class
# otuclust %>% mode
# otuclust %>% as.dendrogram %>% str 
# otuclust %>% plot

table <- top_normal %>% add_rownames
# table$rowname <- with(otuclust, reorder(labels, desc(order)))
table$rowname <- table$rowname[order.dendrogram(den_order)]

top_melt <- table %>% 
    select(rowname,os7,os8,os9,os10,os11,os12) %>% 
      melt
(p <- ggplot(top_melt, aes(variable, rowname)) + geom_tile(aes(fill = log10(value)), colour = "white") + scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 2) + theme(axis.text.y = element_text(size = 1), axis.text.x = element_text(size = 4)) + coord_fixed(ratio=0.15))
```
## replot with different methods
above result is clustered not very good. So I will try with different subset data or dist methods.
```{r}
cohort2 <- top_normal %>% 
  add_rownames %>% 
    select(rowname,os7,os8,os9,os10,os11,os12)
rorder <- cohort2 %>% 
  dist(method = "binary") %>%  
    hclust(method = "average") %>% 
      as.dendrogram 
cohort2$rowname %>% str
cohort2$rowname <- cohort2$rowname[order.dendrogram(rorder)]
top_melt <- cohort2 %>%
  melt
(p <- ggplot(top_melt, aes(variable, rowname)) + geom_tile(aes(fill = log10(value)), colour = "white") + scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 2) + theme(axis.text.y = element_text(size = 1), axis.text.x = element_text(size = 4)) + coord_fixed(ratio=0.15))

```


